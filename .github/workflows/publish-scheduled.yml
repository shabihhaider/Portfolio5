name: Publish Scheduled Posts

on:
    schedule:
        # Run every day at 10 AM UTC
        - cron: "0 10 * * *"
    workflow_dispatch:

jobs:
    publish:
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            - uses: actions/setup-node@v4
              with:
                  node-version: "20"

            - run: npm ci

            - name: Publish scheduled posts
              env:
                  MONGODB_URI: ${{ secrets.MONGODB_URI }}
                  GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
                  # GROQ_API_KEY might be needed if script imports it even if not used,
                  # but verify-db script separates imports.
                  # publish-scheduled.ts imports PostsDB which imports mongodb.ts which uses env vars.
              run: npx tsx scripts/publish-scheduled.ts

            - name: Trigger Vercel rebuild
              run: |
                  if [ -n "${{ secrets.VERCEL_HOOK }}" ]; then
                      curl -X POST https://api.vercel.com/v1/integrations/deploy/${{ secrets.VERCEL_HOOK }}
                  else
                      echo "VERCEL_HOOK secret not set, skipping deployment trigger."
                  fi
