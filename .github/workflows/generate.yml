name: Generate Blog Post (3√ó/week)

on:
  schedule:
    # Monday 9:00 UTC, Wednesday 9:00 UTC, Friday 9:00 UTC
    - cron: '0 9 * * 1,3,5'
  workflow_dispatch: # Allow manual trigger from GitHub UI

jobs:
  generate:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Generate blog post via API
        id: generate
        run: |
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST "${{ secrets.SITE_URL }}/api/generate" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.ADMIN_API_TOKEN }}" \
            -d '{}')

          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | head -n -1)

          echo "status=$HTTP_CODE" >> $GITHUB_OUTPUT
          echo "body=$BODY" >> $GITHUB_OUTPUT

          if [ "$HTTP_CODE" != "200" ]; then
            echo "::error::Generation failed with status $HTTP_CODE: $BODY"
            exit 1
          fi

          # Extract slug and title from JSON response
          SLUG=$(echo "$BODY" | jq -r '.slug // empty')
          TITLE=$(echo "$BODY" | jq -r '.title // empty')
          SCORE=$(echo "$BODY" | jq -r '.qualityScore // empty')

          echo "slug=$SLUG" >> $GITHUB_OUTPUT
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "score=$SCORE" >> $GITHUB_OUTPUT

      - name: Create GitHub Issue with preview link
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const slug = '${{ steps.generate.outputs.slug }}';
            const title = '${{ steps.generate.outputs.title }}';
            const score = '${{ steps.generate.outputs.score }}';
            const siteUrl = '${{ secrets.SITE_URL }}';

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üìù New Draft: ${title}`,
              body: [
                `## New Blog Post Generated`,
                ``,
                `**Title:** ${title}`,
                `**Quality Score:** ${score}/10`,
                `**Preview:** [View Draft](${siteUrl}/blog/${slug})`,
                ``,
                `### Next Steps`,
                `1. Review the draft at the preview link above`,
                `2. Go to [Admin Dashboard](${siteUrl}/admin) to approve, edit, or reject`,
                `3. Approved posts will be auto-published at their scheduled time`,
                ``,
                `---`,
                `*Auto-generated by blog automation workflow*`,
              ].join('\n'),
              labels: ['blog-draft', 'automation'],
            });

      - name: Create failure issue
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const body = '${{ steps.generate.outputs.body }}';
            const status = '${{ steps.generate.outputs.status }}';

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `‚ùå Blog Generation Failed`,
              body: [
                `## Generation Failed`,
                ``,
                `**HTTP Status:** ${status}`,
                `**Response:** \`\`\`${body}\`\`\``,
                ``,
                `Check the [workflow run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) for details.`,
                ``,
                `---`,
                `*Auto-generated by blog automation workflow*`,
              ].join('\n'),
              labels: ['bug', 'automation'],
            });
