name: Publish Scheduled Posts

on:
  schedule:
    # Every 6 hours: 00:00, 06:00, 12:00, 18:00 UTC
    - cron: '0 */6 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  publish:
    runs-on: ubuntu-latest
    timeout-minutes: 2

    steps:
      - name: Publish approved/scheduled posts via API
        id: publish
        run: |
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X GET "${{ secrets.SITE_URL }}/api/cron/publish" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}")

          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | head -n -1)

          echo "status=$HTTP_CODE" >> $GITHUB_OUTPUT
          echo "body=$BODY" >> $GITHUB_OUTPUT

          if [ "$HTTP_CODE" != "200" ]; then
            echo "::error::Publish cron failed with status $HTTP_CODE: $BODY"
            exit 1
          fi

          echo "✅ Publish cron completed: $BODY"

      - name: Create failure issue
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const body = '${{ steps.publish.outputs.body }}';
            const status = '${{ steps.publish.outputs.status }}';

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `❌ Publish Cron Failed`,
              body: [
                `## Publish Cron Failed`,
                ``,
                `**HTTP Status:** ${status}`,
                `**Response:** \`\`\`${body}\`\`\``,
                ``,
                `Check the [workflow run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) for details.`,
                ``,
                `---`,
                `*Auto-generated by blog automation workflow*`,
              ].join('\n'),
              labels: ['bug', 'automation'],
            });
